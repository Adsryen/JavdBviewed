# 观影习惯报告（标签版）方案与待办

## 决策与范围（已确认）
- [x] 仅统计与分析「标签（Tag）」；暂不纳入演员/系列。
- [x] AI：使用一套 HTML 模板，由 AI 填充“文本区块”；图表均本地渲染（不交由 AI 生成）。（模板/本地图表已完成；AI 接入已完成，默认关闭）
- [x] 触发：提供“每月报告”自动生成与持久化；支持查看历史与备份/恢复。

## 功能流程（自上而下）
1) 采集
- [x] 从影片详情/列表解析标签；按影片 ID 去重，仅首次计数。
- [x] 将每日标签计数聚合到日粒度记录。

2) 聚合
- [ ] 将日记录按月聚合，产出：标签 TopN、占比、日/周趋势、显著变化（新偏好/上升/下降）。（TopN/按日趋势已完成；显著变化已实现；周趋势未实现）

3) 生成
- [x] 本地统计计算 + 本地 ECharts 渲染图表（默认使用 ECharts）。
- [x] 将结构化统计数据 + HTML 模板（src/assets/templates/insights-report.html）传递给 AI，仅填充“文本占位符”（标题/摘要/洞察/方法说明等；已接入，默认关闭；非法 HTML 自动回退 JSON 字段）。

4) 存储
  - [x] `views`（日表）：保存每日标签计数与去重用的影片 ID 集。
  - [x] `reports`（月表）：保存月度统计、已填充 HTML 报告与元信息。

5) 展示
- [ ] 首页注入入口按钮（工具条或小卡片）。点击打开 Popup 的“报告”页。（首页入口未实现）
- [ ] Popup：生成本月报告、浏览历史月报（保留 24 个月）、导出 HTML/Markdown、备份/恢复。（除 Markdown 导出外均已完成）

6) 定时与通知
- [ ] 后台 `alarms`：每月 1 日本地时区 00:10 触发，尝试生成“上月报告”（时间可在设置中调整）。 （定时已实现；“设置可调”未实现）
- [x] 离线补偿：若错过触发（电脑未开机/浏览器未运行），在扩展激活或浏览器启动后进行补偿检测；如发现“上月尚无正式月报”，则补偿生成。
- [ ] 手动生成：Popup 支持手动生成当月/上月报告；生成后弹出“保存为正式月报？”确认；如当月已存在正式月报，提供“覆盖/另存副本/仅预览”选项。（基础生成已实现；保存确认与多选项未实现）
- [x] 通知：生成成功/失败以系统通知提示，并提供“查看报告/打开历史”的快捷入口。

## 数据结构（建议）
- `views`（按日）：
```json
{
  "date": "2025-10-18",
  "tags": { "剧情": 12, "萝莉": 8 },
  "movies": ["J12345", "J23456"],
  "status": "pending"
}
```

- `reports`（按月）：
```json
{
  "month": "2025-10",
  "period": { "start": "2025-10-01", "end": "2025-10-31" },
  "stats": {
    "tagsTop": [{ "name": "剧情", "count": 120, "ratio": 0.34 }],
    "trend": [{ "date": "2025-10-01", "total": 8 }],
    "changes": { "newTags": [], "rising": [], "falling": [] }
  },
  "html": "<!doctype html>...",
  "createdAt": 1697587200000,
  "finalizedAt": 1697673600000,
  "status": "final",
  "origin": "auto",
  "version": "x.y.z"
}
```

## 模板与提示词（核心）
- 模板职责：
  - [x] 模板文件位置：`src/assets/templates/insights-report.html`
  - [x] 仅包含文本占位符（例如：`{{reportTitle}}`、`{{periodText}}`、`{{summary}}`、`{{insightList}}`、`{{methodology}}`）。
  - [x] 图表容器（如 `#tags-pie`, `#tags-top-bar`, `#trend-line`）由前端本地脚本渲染。
- AI 输出：
  - [x] 首选：返回“整段 HTML（仅替换文本占位符，不增加/删除节点，不引入外部脚本/样式）”。（已接入于 `reportGenerator.generateReportHTML()`）
  - [x] 回退：若返回非法 HTML，则要求 AI 仅返回 JSON 文本字段（如 `{"reportTitle": "...", "summary": "..."}`），前端再合并进模板。（已接入于 `reportGenerator.generateReportHTML()`）
- 提示词要点：
  - [x] 输入（结构化 + 模板）：
    - `periodText`: 期文字段（如“统计范围：2025-10-01 ~ 2025-10-31”）。
    - `stats`: 聚合统计（`tagsTop[] { name,count,ratio }`、`trend[] { date,total }`、`changes { newTags[], rising[], falling[] }`）。
    - `templateHTML`: 完整 HTML 模板（包含占位符）。
    - `requiredFields`: `['reportTitle','periodText','summary','insightList','methodology']`（用于 JSON 回退时的字段集合）。
  - 约束（与实现对齐）：
    - 只替换 `{{...}}` 占位符，不增加/删除任何节点与属性；不得插入 `script/link/style/iframe`。
    - 文案使用简体中文、客观克制：摘要 ≤ 200 字；洞察 3–5 条，单条 ≤ 120 字，强调“新出现/上升/下降”的显著变化。
    - 输出优先为“完整 HTML（仅替换占位符）”；若无法保证合法 HTML，则仅返回 JSON 字段集合。
  - [x] 产出与回退：
    - 完整 HTML：保留 `<base>` 与 `<template id="insights-data">`。若 AI 未输出，生成器会补齐 `baseHref` 与 `statsJSON`。
    - JSON 回退：示例结构
      ```json
      {
        "reportTitle": "我的观影标签月报（2025年10月）",
        "periodText": "统计范围：2025-10-01 ~ 2025-10-31",
        "summary": "本报告基于本地聚合，仅统计标签……",
        "insightList": "<li>本月偏好标签集中于：剧情(120)、萝莉(80)…</li>\n<li>累计观看天数：20 天</li>",
        "methodology": "按影片ID去重，月度聚合 TopN、占比与趋势。"
      }
      ```
- 示例系统提示（简化版）：
```
你将收到一个 HTML 模板（含占位符）与结构化统计数据（仅标签）。
目标：用正式、克制的中文生成“报告标题、摘要段落、3-5条洞察列表、可选方法说明”。
严格规则：
1) 仅替换 {{...}} 占位符，不增加或删除任何节点与属性；不要注入 script/link/style。
2) 不得输出与输入无关的内容，不加入外部资源链接。
3) 摘要 ≤200字；洞察每条 ≤120字，强调显著变化与新出现/上升/下降的标签。
输出优先为完整 HTML；若无法生成有效 HTML，则只返回 JSON 字段。
```
- 示例占位符说明：
  - `{{reportTitle}}`：如“我的观影标签月报（2025年10月）”。
  - `{{periodText}}`：如“统计范围：2025-10-01 ~ 2025-10-31”。
  - `{{summary}}`：一段总览介绍。
  - `{{insightList}}`：若为 HTML 模式，输出 `<li>...</li>` 片段（3–5 条）。
  - `{{methodology}}`：可简述口径与局限。

### 提示词正式稿（与实现同步）
以下为当前生成器 `buildPromptMessages()` 使用的核心约束（精简为文档版，可直接复用）：

```
你将收到一个 HTML 模板（含文本占位符）与结构化统计数据（仅标签）。
目标：生成“报告标题、摘要段落、3-5条洞察列表、可选方法说明”的中文内容。
严格规则：
1) 仅替换 {{...}} 占位符，不增加或删除节点与属性，不注入 script/link/style。
2) 不输出与输入无关的内容，不加入外部资源链接。
3) 摘要 ≤200字；洞察每条 ≤120字，强调显著变化与新出现/上升/下降的标签。
输出优先为“完整HTML（仅替换占位符）”；若无法保证合法HTML，则只返回 JSON 字段（如 {"reportTitle":"...","summary":"..."}）。
```

输入载荷包含：`periodText`、`stats`（含 TopN/趋势/变化）、`templateHTML`、`requiredFields`。


## UI/交互（Popup + 首页入口）
- [ ] 首页入口：右上角工具条按钮或页面浮动卡片；点击 -> 打开 Popup 的“报告”页。（未实现）
- Popup“报告”页：
  - [ ] 顶部：时间选择器（默认“上个月”）、“生成报告”按钮、AI 开关状态提示。（已有时间选择与生成按钮；AI 开关提示未实现）
  - [x] 按钮配色与排版优化（报告页控件区）。（已完成）
  - [x] 历史：按月卡片列表（预览/查看/导出/删除）。
  - [ ] 生成后：弹出保存确认（保存为正式月报/覆盖/另存副本/仅预览）。
  - [ ] 预览：在新弹层或新页签打开，支持“保存为月报”。（当前为内嵌 iframe 预览）

## 定时与通知
- 后台 `alarms`：每月 1 日本地时区 00:10 触发，尝试生成“上月报告”（时间可在设置中调整）。
- 离线补偿：若错过触发（电脑未开机/浏览器未运行），在扩展激活或浏览器启动后进行补偿检测；如发现“上月尚无正式月报”，则补偿生成。
- 手动生成：Popup 支持手动生成当月/上月报告；生成后弹出“保存为正式月报？”确认；如当月已存在正式月报，提供“覆盖/另存副本/仅预览”选项。
- 通知：生成成功/失败以系统通知提示，并提供“查看报告/打开历史”的快捷入口。

## 备份/恢复
- [x] 备份导出：将 `reports`（JSON + 内嵌 HTML）导出为单文件。（当前为单一 JSON 文件）
- [ ] 恢复导入：结构校验与版本兼容，避免重复写入。（目前为基础导入，缺少严格校验/去重）
- [ ] 同步策略：`chrome.storage.sync` 仅存索引清单（避免超限），正文留在 IndexedDB。（未实现）

## 设置项（建议）
 - [ ] AI：启用开关、API Key、端点 URL、模型名、超时与重试；“仅本地模式”开关。
   - [x] 已接入报告生成流程：启用开关/API Key/端点 URL/模型名/超时
   - [ ] 重试策略（聊天补全层面）
   - [ ] 显著变化阈值接入（聚合参数外露为设置）
 - [ ] 报告：默认时间窗（上个月）、显著变化阈值、导出格式偏好、手动生成默认保存策略（确认/自动保存/仅预览）。
 - [ ] 定时：开启/关闭、执行日（默认 1 号）、触发时刻（默认 00:10）、离线补偿开关、失败通知。（当前为固定策略）
 - [ ] 历史保留：保留月数（默认 24），超限自动清理。（目前为固定值 24）
 - [x] 隐私：是否允许向 AI 发送聚合数据（通过 AI 启用开关控制，默认关闭）。

## 开发任务拆分（对应 TODO）
- [x] 标签采集器（content）与去重
- [x] 聚合与 IndexedDB 封装（`views`/`reports`）
- [x] 报告生成器（本地统计 + 模板 + AI 填充/回退）。（AI 填充/回退已接入，默认关闭）
- [ ] Popup 报告页 + 历史列表 + 预览/导出/导入。（除 Markdown 导出外均完成；历史“预览”为静态）
 - [x] 后台定时与通知 + 离线补偿检测 + 历史保留清理
 - [ ] 首页入口注入
 - [ ] 模板文件与提示词定义（`src/assets/templates/insights-report.html` + prompts）。（模板已完成；提示词未完成）
- [ ] 设置页集成（AI/定时/时间窗/隐私）
- [ ] 单元/端到端测试与性能优化

## 优先级与待办（同步 2025-10-20）

### P0（解锁 M2 的最小链路）
- [x] 显著变化计算：按上月对比生成 `changes.newTags/rising/falling`（默认阈值 8%，最小计数 3；已接入前台/后台）。
- [x] AI 接入：模板文本填充；非法 HTML 回退 JSON 字段（不改 Popup UI）。
- [x] 提示词成稿：输入字段/约束/产出示例，字数限制与安全规则（已与实现同步）。
- [ ] 设置页接入报告流程：API Key/端点/模型/超时/重试/隐私“仅本地模式”/显著变化阈值。
  - [x] API Key/端点/模型/超时（已接入）
  - [x] 隐私“仅本地模式”（通过 AI 开关控制，默认关闭）
  - [ ] 重试策略
  - [ ] 显著变化阈值

### P1（可用性与关键路径）
- [ ] 首页入口注入：按钮/卡片 -> 打开现有 Popup 报告页。
- [ ] 手动生成流程完善：保存确认与策略（覆盖/副本/仅预览）、预览增强。
- [ ] 恢复导入：结构校验与去重，失败提示友好。
- [ ] 定时“设置可调”：开启/关闭、执行日、触发时刻、离线补偿。

### P2（体验与可靠性）
- [ ] Markdown 导出补齐（与 HTML 一致的文本输出）。
- [ ] 历史预览增强：弹层/新页签查看。
- [ ] 同步策略：`chrome.storage.sync` 仅存索引，正文留 IndexedDB。
- [ ] 单元/端到端测试与性能优化。

### P3（文案与规范）
- [ ] 方法学/占位符文案细化，统一语气与格式。

### 已完成（本次同步）
- [x] 报告页按钮配色与排版优化。
- [x] 聚合：显著变化计算。
- [x] AI 接入 + JSON 回退（前台/后台接入；默认关闭）。

## 里程碑
- [x] M1：标签采集 + 月度聚合 + Popup 查看/导出（本地，无 AI）。（Markdown 导出未完成）
- [ ] M2：模板与提示词 + AI 填充文本（图表仍本地）
- [ ] M3：定时月报 + 历史与备份/恢复 + 首页入口（定时/历史/备份已完成；首页入口未完成）

## 风险与回退
- AI 产出不合规：回退 JSON 字段合成；模板只接受安全文本。
- 数据量增长：月度压缩（删除 `movies`，保留计数）；旧数据归档。
- 首次/低数据量：在报告中提示“样本不足”，并提供使用引导。
