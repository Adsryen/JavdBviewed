/*! For license information please see background.js.LICENSE.txt */
(()=>{function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(){var t,n,o="function"==typeof Symbol?Symbol:{},c=o.iterator||"@@iterator",a=o.toStringTag||"@@toStringTag";function s(e,o,c,a){var s=o&&o.prototype instanceof u?o:u,l=Object.create(s.prototype);return r(l,"_invoke",function(e,r,o){var c,a,s,u=0,l=o||[],f=!1,p={p:0,n:0,v:t,a:b,f:b.bind(t,4),d:function(e,r){return c=e,a=0,s=t,p.n=r,i}};function b(e,r){for(a=e,s=r,n=0;!f&&u&&!o&&n<l.length;n++){var o,c=l[n],b=p.p,y=c[2];e>3?(o=y===r)&&(s=c[(a=c[4])?5:(a=3,3)],c[4]=c[5]=t):c[0]<=b&&((o=e<2&&b<c[1])?(a=0,p.v=r,p.n=c[1]):b<y&&(o=e<3||c[0]>r||r>y)&&(c[4]=e,c[5]=r,p.n=y,a=0))}if(o||e>1)return i;throw f=!0,r}return function(o,l,y){if(u>1)throw TypeError("Generator is already running");for(f&&1===l&&b(l,y),a=l,s=y;(n=a<2?t:s)||!f;){c||(a?a<3?(a>1&&(p.n=-1),b(a,s)):p.n=s:p.v=s);try{if(u=2,c){if(a||(o="next"),n=c[o]){if(!(n=n.call(c,s)))throw TypeError("iterator result is not an object");if(!n.done)return n;s=n.value,a<2&&(a=0)}else 1===a&&(n=c.return)&&n.call(c),a<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),a=1);c=t}else if((n=(f=p.n<0)?s:e.call(r,p))!==i)break}catch(e){c=t,a=1,s=e}finally{u=1}}return{value:n,done:f}}}(e,c,a),!0),l}var i={};function u(){}function l(){}function f(){}n=Object.getPrototypeOf;var p=[][c]?n(n([][c]())):(r(n={},c,function(){return this}),n),b=f.prototype=u.prototype=Object.create(p);function y(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,r(t,a,"GeneratorFunction")),t.prototype=Object.create(b),t}return l.prototype=f,r(b,"constructor",f),r(f,"constructor",l),l.displayName="GeneratorFunction",r(f,a,"GeneratorFunction"),r(b),r(b,a,"Generator"),r(b,c,function(){return this}),r(b,"toString",function(){return"[object Generator]"}),(e=function(){return{w:s,m:y}})()}function r(t,e,n,o){var c=Object.defineProperty;try{c({},"",{})}catch(t){c=0}r=function(t,e,n,o){if(e)c?c(t,e,{value:n,enumerable:!o,configurable:!o,writable:!o}):t[e]=n;else{var a=function(e,n){r(t,e,function(t){return this._invoke(e,n,t)})};a("next",0),a("throw",1),a("return",2)}},r(t,e,n,o)}function n(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function o(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?n(Object(r),!0).forEach(function(e){c(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function c(e,r,n){return(r=function(e){var r=function(e){if("object"!=t(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,"string");if("object"!=t(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==t(r)?r:r+""}(r))in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}function a(t,e,r,n,o,c,a){try{var s=t[c](a),i=s.value}catch(t){return void r(t)}s.done?e(i):Promise.resolve(i).then(n,o)}chrome.runtime.onMessage.addListener(function(t,r,n){function c(){var r;return r=e().m(function r(){var c,a,s,i,u,l,f,p,b,y,h,v,g,d,m,O,w,j,P,T,S,D;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:if(console.log("Received WebDAV message:",t),"webdav-test"!==t.type){e.n=5;break}return c=t.settings,a=c.url,s=c.username,i=c.password,console.log("Testing WebDAV connection to:",a),e.p=1,e.n=2,fetch(a,{method:"PROPFIND",headers:{Depth:"0",Authorization:"Basic "+btoa("".concat(s,":").concat(i))}});case 2:u=e.v,console.log("WebDAV test response:",u.status,u.statusText),u.status>=200&&u.status<300?n({success:!0}):n({success:!1,error:"".concat(u.status," ").concat(u.statusText)}),e.n=4;break;case 3:e.p=3,S=e.v,console.error("WebDAV test fetch error:",S),n({success:!1,error:S.message});case 4:e.n=13;break;case 5:if("webdav-upload"!==t.type){e.n=13;break}return l=t.settings,f=t.data,p=l.url,b=l.username,y=l.password,h=l.path,console.log("Uploading to WebDAV path:",h),v=JSON.stringify(f,null,2),g=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19),d="javdb-backup_".concat(g,".json"),m=h.endsWith("/")?h:"".concat(h,"/"),O=new URL(m,p).href,w=new URL(d,O).href,console.log("Full folder path:",O),console.log("Full file path:",w),j={Authorization:"Basic "+btoa("".concat(b,":").concat(y))},e.p=6,console.log("Attempting to create directory (MKCOL):",O),e.n=7,fetch(O,{method:"MKCOL",headers:j});case 7:if(P=e.v,console.log("MKCOL response:",P.status,P.statusText),201===P.status||405===P.status||P.status>=200&&P.status<300){e.n=8;break}throw new Error("创建目录失败: ".concat(P.status," ").concat(P.statusText));case 8:return console.log("Attempting to upload file (PUT):",w),e.n=9,fetch(w,{method:"PUT",headers:o(o({},j),{},{"Content-Type":"application/json;charset=utf-8"}),body:v});case 9:if(T=e.v,console.log("PUT response:",T.status,T.statusText),!(T.status>=200&&T.status<300)){e.n=10;break}console.log("WebDAV upload successful."),n({success:!0}),e.n=11;break;case 10:throw new Error("上传失败: ".concat(T.status," ").concat(T.statusText));case 11:e.n=13;break;case 12:e.p=12,D=e.v,console.error("WebDAV upload error:",D),n({success:!1,error:D.message});case 13:return e.a(2)}},r,null,[[6,12],[1,3]])}),c=function(){var t=this,e=arguments;return new Promise(function(n,o){var c=r.apply(t,e);function s(t){a(c,n,o,s,i,"next",t)}function i(t){a(c,n,o,s,i,"throw",t)}s(void 0)})},c.apply(this,arguments)}if(t.type.startsWith("webdav-"))return function(){c.apply(this,arguments)}(),!0})})();