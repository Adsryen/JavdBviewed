/*! For license information please see content.js.LICENSE.txt */
(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t,n){return chrome.storage.local.set((r={},a=n,(o=function(t){var n=function(t){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=e(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(n)?n:n+""}(o=t))in r?Object.defineProperty(r,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):r[o]=a,r));var r,o,a}function n(e,t){return new Promise(function(n){chrome.storage.local.get([e],function(r){n(void 0!==r[e]?r[e]:t)})})}function r(e){return new Promise(function(t){return setTimeout(t,e)})}function o(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function c(n,r,o,i){var c=r&&r.prototype instanceof l?r:l,s=Object.create(c.prototype);return a(s,"_invoke",function(n,r,o){var a,i,c,l=0,s=o||[],d=!1,f={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,i=0,c=e,f.n=n,u}};function p(n,r){for(i=n,c=r,t=0;!d&&l&&!o&&t<s.length;t++){var o,a=s[t],p=f.p,m=a[2];n>3?(o=m===r)&&(c=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=n<2&&p<a[1])?(i=0,f.v=r,f.n=a[1]):p<m&&(o=n<3||a[0]>r||r>m)&&(a[4]=n,a[5]=r,f.n=m,i=0))}if(o||n>1)return u;throw d=!0,r}return function(o,s,m){if(l>1)throw TypeError("Generator is already running");for(d&&1===s&&p(s,m),i=s,c=m;(t=i<2?e:c)||!d;){a||(i?i<3?(i>1&&(f.n=-1),p(i,c)):f.n=c:f.v=c);try{if(l=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(d=f.n<0)?c:n.call(r,f))!==u)break}catch(t){a=e,i=1,c=t}finally{l=1}}return{value:t,done:d}}}(n,o,i),!0),s}var u={};function l(){}function s(){}function d(){}t=Object.getPrototypeOf;var f=[][r]?t(t([][r]())):(a(t={},r,function(){return this}),t),p=d.prototype=l.prototype=Object.create(f);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,a(e,i,"GeneratorFunction")),e.prototype=Object.create(p),e}return s.prototype=d,a(p,"constructor",d),a(d,"constructor",s),s.displayName="GeneratorFunction",a(d,i,"GeneratorFunction"),a(p),a(p,i,"Generator"),a(p,r,function(){return this}),a(p,"toString",function(){return"[object Generator]"}),(o=function(){return{w:c,m}})()}function a(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}a=function(e,t,n,r){if(t)o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n;else{var i=function(t,n){a(e,t,function(e){return this._invoke(t,n,e)})};i("next",0),i("throw",1),i("return",2)}},a(e,t,n,r)}function i(e,t){return s(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,i,c=[],u=!0,l=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=a.call(n)).done)&&(c.push(r.value),c.length!==t);u=!0);}catch(e){l=!0,o=e}finally{try{if(!u&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(l)throw o}}return c}}(e,t)||u(e,t)||c()}function c(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function u(e,t){if(e){if("string"==typeof e)return l(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function s(e){if(Array.isArray(e))return e}function d(e,t,n,r,o,a,i){try{var c=e[a](i),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,o)}function f(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){d(a,r,o,i,c,"next",e)}function c(e){d(a,r,o,i,c,"throw",e)}i(void 0)})}}!function(){var e,a=chrome.runtime.getURL("src/assets/jav.png");function l(){var e=document.querySelector("link[rel~='icon']");return e||((e=document.createElement("link")).rel="icon",document.head.appendChild(e)),e}function d(e){var t=document.head;document.querySelectorAll("link[rel~='icon']").forEach(function(e){return e.remove()});var n=document.createElement("link");n.rel="icon",e.endsWith(".png")&&(n.type="image/png"),n.href=e,t.appendChild(n)}e=l().href;function p(e){return m.apply(this,arguments)}function m(){return(m=f(o().m(function e(t){var r,a,c,u,l,s,d,f,p,m,v,h,y,b,g,w,x,S,k;return o().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Promise.all([n("hideWatchedVideos",!1),n("hideViewedVideos",!1),n("hideVRVideos",!1),n("myIds",[]),n("videoBrowseHistory",[])]);case 1:if(c=e.v,u=i(c,5),l=u[0],s=u[1],d=u[2],f=u[3],p=u[4],m=new Set(f),v=new Set(p),h=null===(r=t.querySelector("div.video-title > strong"))||void 0===r?void 0:r.textContent.trim(),y=(null===(a=t.querySelector("div.video-title > span.x-btn"))||void 0===a?void 0:a.getAttribute("data-title"))||"",h){e.n=2;break}return e.a(2);case 2:if(!d||!y.includes("【VR】")){e.n=3;break}return(b=t.closest(".item"))&&(b.style.display="none"),e.a(2);case 3:if(!s||!v.has(h)){e.n=4;break}return(g=t.closest(".item"))&&(g.style.display="none"),e.a(2);case 4:if(!l||!m.has(h)){e.n=5;break}return(w=t.closest(".item"))&&(w.style.display="none"),e.a(2);case 5:if(x=t.closest(".item").querySelector(".tags.has-addons")){e.n=6;break}return e.a(2);case 6:m.has(h)?Array.from(x.querySelectorAll("span")).some(function(e){return"我看過這部影片"===e.textContent})||((S=document.createElement("span")).className="tag is-success is-light",S.textContent="我看過這部影片",x.appendChild(S)):v.has(h)&&(Array.from(x.querySelectorAll("span")).some(function(e){return["我看過這部影片","已浏览"].includes(e.textContent)})||((k=document.createElement("span")).className="tag is-warning is-light",k.textContent="已浏览",x.appendChild(k)));case 7:return e.a(2)}},e)}))).apply(this,arguments)}function v(){return h.apply(this,arguments)}function h(){return(h=f(o().m(function e(){var t,n,r,a;return o().w(function(e){for(;;)switch(e.n){case 0:t=Array.from(document.querySelectorAll(".movie-list .item a")),n=0,r=t;case 1:if(!(n<r.length)){e.n=3;break}return a=r[n],e.n=2,p(a);case 2:n++,e.n=1;break;case 3:return e.a(2)}},e)}))).apply(this,arguments)}var y=document.querySelector(".movie-list");function b(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return 1e3*Math.floor(Math.random()*(t-e+1)+e)}function g(){return(g=f(o().m(function e(){var a,i,c,u,l,s,d,f;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(a=/<strong>番號:<\/strong>\s*&nbsp;<span class="value"><a href="\/video_codes\/([A-Z]+)">([A-Z]+)<\/a>-(\d+)<\/span>/,!(i=document.querySelector(".panel-block.first-block"))){e.n=16;break}if(!(c=i.innerHTML.match(a))){e.n=16;break}return u="".concat(c[1],"-").concat(c[3]),l=b(),console.log("等待 ".concat(l/1e3," 秒后开始记录浏览: ").concat(u)),e.n=1,r(l);case 1:s=5;case 2:if(!(s>0)){e.n=16;break}return e.p=3,e.n=4,n("videoBrowseHistory",[]);case 4:if((d=e.v).includes(u)){e.n=10;break}return d.push(u),e.n=5,t("videoBrowseHistory",d);case 5:return e.n=6,r(200);case 6:return e.n=7,n("videoBrowseHistory",[]);case 7:if(!e.v.includes(u)){e.n=8;break}return console.log("成功记录浏览: ".concat(u)),e.a(2);case 8:throw new Error("验证存储失败");case 9:e.n=11;break;case 10:return console.log("浏览记录已存在: ".concat(u)),e.a(2);case 11:e.n=15;break;case 12:if(e.p=12,f=e.v,s--,console.error("记录浏览失败: ".concat(u,", 错误: ").concat(f.message,". 剩余重试次数: ").concat(s)),!(s>0)){e.n=14;break}return e.n=13,r(3e3);case 13:e.n=15;break;case 14:console.error("记录浏览失败: ".concat(u,", 已达最大重试次数"));case 15:e.n=2;break;case 16:return e.a(2)}},e,null,[[3,12]])}))).apply(this,arguments)}y?(v(),new MutationObserver(function(){v()}).observe(y,{childList:!0,subtree:!0})):v(),setInterval(function(){var t=l().href;if(window.location.href.startsWith("https://javdb.com/v/")){var r=document.querySelector(".panel-block.first-block");if(r){var o=r.innerHTML.match(/<strong>番號:<\/strong>\s*&nbsp;<span class="value"><a href="\/video_codes\/([A-Z]+)">[A-Z]+<\/a>-(\d+)<\/span>/);if(o){var i="".concat(o[1],"-").concat(o[2]);n("myIds",[]).then(function(r){n("videoBrowseHistory",[]).then(function(n){var o=new Set(r),c=new Set(n);o.has(i)||c.has(i)?t!==a&&d(a):e&&t!==e&&d(e)})})}}}else e&&t!==e&&d(e)},2e3),window.location.href.startsWith("https://javdb.com/v/")&&function(){g.apply(this,arguments)}();var w=[],x={allowExport:!1,currentPage:1,maxPage:null},S=!1,k=null,P=null;function j(){var e=document.querySelectorAll(".item");return Array.from(e).map(function(e){var t,n=s(t=e.querySelector(".video-title").textContent.trim().split(" "))||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||u(t)||c(),r=n[0];return n.slice(1),{id:r,releaseDate:e.querySelector(".meta").textContent.replace(/[^0-9-]/g,"")}})}function C(){var e=document.querySelector("a.is-active");if(e){var t=e.textContent.match(/\((\d+)\)/);if(t)return parseInt(t[1],10)}return 0}function E(e,t){return Math.ceil(e/t)}function q(){if(0!==w.length){var e=JSON.stringify(w,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),r=document.createElement("a"),o=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19),a="javdb-export",i=window.location.href;if(i.includes("/watched_videos"))a="watched-videos";else if(i.includes("/want_watch_videos"))a="want-watch-videos";else if(i.includes("/list_detail")){var c=document.querySelector(".title.is-4");c&&(a=c.textContent.trim())}else if(i.includes("/lists")){var u=document.querySelector(".title.is-4");u&&(a=u.textContent.trim())}r.download="".concat(a,"_").concat(o,".json"),r.href=n,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}}function A(){var e=new URLSearchParams(window.location.search).get("page");return e?parseInt(e):1}function O(){return(O=f(o().m(function e(){var n,r,a,i,c,u;return o().w(function(e){for(;;)switch(e.n){case 0:if(n=document.getElementById("maxPageInput")){e.n=1;break}return console.error("找不到页数输入框"),e.a(2);case 1:if(r=C(),a=E(r,20),i=n.value?parseInt(n.value):a,c=A(),!((u=Math.min(c+i-1,a))<c)){e.n=2;break}return alert("请输入有效的页数"),e.a(2);case 2:return x.currentPage=c,x.maxPage=u,x.allowExport=!0,e.n=3,t("exportState",x);case 3:w=[],k.textContent="导出中...(".concat(c,"/").concat(u,")"),k.disabled=!0,P.disabled=!1,S=!0,_();case 4:return e.a(2)}},e)}))).apply(this,arguments)}function _(){return I.apply(this,arguments)}function I(){return(I=f(o().m(function e(){var n,r;return o().w(function(e){for(;;)switch(e.n){case 0:if(S&&!(x.currentPage>x.maxPage)){e.n=1;break}return T(),e.a(2);case 1:return n=j(),w=w.concat(n),k.textContent="导出中...(".concat(x.currentPage,"/").concat(x.maxPage,")"),x.currentPage++,e.n=2,t("exportState",x);case 2:x.currentPage<=x.maxPage?(r="".concat(window.location.pathname,"?page=").concat(x.currentPage),window.location.href=r):T();case 3:return e.a(2)}},e)}))).apply(this,arguments)}function T(){return L.apply(this,arguments)}function L(){return(L=f(o().m(function e(){return o().w(function(e){for(;;)switch(e.n){case 0:return w.length>0&&q(),S=!1,x.allowExport=!1,x.currentPage=1,x.maxPage=null,e.n=1,t("exportState",x);case 1:k.textContent="导出完成",k.disabled=!1,P.disabled=!0;case 2:return e.a(2)}},e)}))).apply(this,arguments)}function M(){return(M=f(o().m(function e(){var t;return o().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,n("exportState",{});case 1:(t=e.v)&&t.allowExport&&(x=t,S=!0,k.textContent="导出中...(".concat(x.currentPage,"/").concat(x.maxPage,")"),k.disabled=!0,P.disabled=!1,_());case 2:return e.a(2)}},e)}))).apply(this,arguments)}[/https:\/\/javdb\.com\/users\/want_watch_videos.*/,/https:\/\/javdb\.com\/users\/watched_videos.*/,/https:\/\/javdb\.com\/users\/list_detail.*/,/https:\/\/javdb\.com\/lists.*/].some(function(e){return e.test(window.location.href)})&&(function(){var e=document.createElement("input");e.type="number",e.id="maxPageInput",e.placeholder="当前页往后导出的页数，留空导全部",e.style.cssText="\n        margin-right: 10px;\n        padding: 6px 12px;\n        border: 1px solid #ddd;\n        border-radius: 4px;\n        font-size: 14px;\n        width: auto;\n        min-width: 50px;\n        box-sizing: border-box;\n        transition: all 0.3s ease;\n        outline: none;\n        background-color: white;\n    ",e.min="1";var n=E(C(),20);e.max=n,(k=document.createElement("button")).textContent="导出 json",k.className="button is-small",k.addEventListener("click",function(){S||function(){O.apply(this,arguments)}()}),(P=document.createElement("button")).textContent="停止导出",P.className="button is-small",P.disabled=!0,P.addEventListener("click",function(){S=!1,P.disabled=!0,k.disabled=!1,k.textContent="导出已停止",t("exportState",{})});var r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.appendChild(e),r.appendChild(k),r.appendChild(P);var o=document.querySelector(".toolbar")||document.querySelector(".breadcrumb")&&document.querySelector(".breadcrumb").querySelector("ul");o&&o.appendChild(r)}(),function(){M.apply(this,arguments)}())}()})();