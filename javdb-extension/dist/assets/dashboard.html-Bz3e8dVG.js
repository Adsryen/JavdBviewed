import"./modulepreload-polyfill-B5Qt9EMX.js";import{V as b,D as C,b as w,g as L,s as k,S as B,a as R}from"./storage-Pif_YOsy.js";const h={settings:C,records:[],isInitialized:!1};async function x(){if(h.isInitialized)return;h.settings=await L();const n=await R(B.VIEWED_RECORDS,{});h.records=Object.values(n),h.isInitialized=!0,console.log("Global state initialized.",h)}function f(n,t="info"){const s=document.getElementById("messageContainer");if(!s){console.error("Message container not found!");return}const a=document.createElement("div"),o=t==="warn"?"info":t;a.className=`toast toast-${o}`,a.textContent=n;const e=document.createElement("i");t==="success"?e.className="fas fa-check-circle":t==="error"?e.className="fas fa-exclamation-circle":e.className="fas fa-info-circle",a.prepend(e),s.appendChild(a),setTimeout(()=>{a.classList.add("show")},10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},5e3)}document.addEventListener("DOMContentLoaded",async()=>{await x(),$(),A(),N(),J(),j(),M(),D(),O()});function $(){const n=document.querySelectorAll(".tab-link"),t=document.querySelectorAll(".tab-content"),s=e=>{var r;if(!e)return;const i=e.getAttribute("data-tab");i&&(n.forEach(c=>c.classList.remove("active")),t.forEach(c=>c.classList.remove("active")),e.classList.add("active"),(r=document.getElementById(i))==null||r.classList.add("active"),history.pushState?history.pushState(null,"",`#${i}`):location.hash=`#${i}`)};n.forEach(e=>{e.addEventListener("click",()=>{if(s(e),e.getAttribute("data-tab")==="tab-logs"){const i=document.getElementById("refresh-logs-button");i&&i.click()}})});const a=window.location.hash.substring(1)||"tab-records",o=document.querySelector(`.tab-link[data-tab="${a}"]`);s(o||n[0])}function D(){const n=document.getElementById("stats-overview");if(!n)return;const t=h.records.length,s=h.records.filter(e=>e.status===b.VIEWED).length,a=h.records.filter(e=>e.status===b.WANT).length,o=h.records.filter(e=>e.status===b.BROWSED).length;n.innerHTML=`
        <div>
            <span class="stat-value">${t}</span>
            <span class="stat-label">总记录</span>
        </div>
        <div>
            <span class="stat-value">${s}</span>
            <span class="stat-label">已观看</span>
        </div>
        <div>
            <span class="stat-value">${o}</span>
            <span class="stat-label">已浏览</span>
        </div>
        <div>
            <span class="stat-value">${a}</span>
            <span class="stat-label">想看</span>
        </div>
    `}function O(){const n=document.getElementById("infoContainer");if(!n)return;const t="1.10.3.1+966a7591-dirty-2025072511",s="dirty",a=o=>{switch(o){case"clean":return"此版本基于一个干净的、已完全提交的 Git 工作区构建。";case"dev":return"此版本包含已暂存但尚未提交的更改 (dev/staged)。";case"dirty":return"警告：此版本包含未跟踪或未暂存的本地修改 (dirty)！";default:return"无法确定此版本的构建状态。"}};n.innerHTML=`
        <div class="info-item">
            <span class="info-label">Version:</span>
            <span class="info-value version-state-${s}" title="${a(s)}">${t}</span>
        </div>
    `}function A(){const n=document.getElementById("searchInput"),t=document.getElementById("filterSelect"),s=document.getElementById("videoList"),a=document.querySelector(".pagination");if(!n||!s)return;let o=1;const e=20;let i=[];function r(){const d=n.value.toLowerCase(),p=t.value;i=h.records.filter(v=>{const l=!d||v.id.toLowerCase().includes(d)||v.title.toLowerCase().includes(d),u=p==="all"||v.status===p;return l&&u})}function c(){if(s.innerHTML="",i.length===0){s.innerHTML='<li class="empty-list">No records match your criteria.</li>';return}const d=(o-1)*e,p=i.slice(d,d+e),v=h.settings.searchEngines[0];p.forEach(l=>{const u=document.createElement("li");u.className="video-item";const E=v?v.urlTemplate.replace("{{ID}}",encodeURIComponent(l.id)):"#";u.innerHTML=`
                <span class="video-id"><a href="${E}" target="_blank">${l.id}</a></span>
                <span class="video-title">${l.title}</span>
                <span class="video-status status-${l.status}">${l.status}</span>
            `,s.appendChild(u)})}function g(){a.innerHTML="";const d=Math.ceil(i.length/e);if(d<=1)return;const p=(l,u=!1,E=!1)=>{const y=document.createElement("button");y.textContent=String(l),typeof l=="number"?(y.className=`page-button ${u?"active":""}`,y.addEventListener("click",()=>{o=l,m()})):(y.className="page-button ellipsis",E=!0),E&&(y.disabled=!0),a.appendChild(y)};if(d<=7)for(let l=1;l<=d;l++)p(l,l===o);else{let l=new Set;l.add(1),l.add(d),l.add(o);for(let y=-1;y<=1;y++)o+y>0&&o+y<=d&&l.add(o+y);let u=Array.from(l).sort((y,T)=>y-T),E=null;for(const y of u)E!==null&&y-E>1&&p("..."),p(y,y===o),E=y}}function m(){c(),g()}n.addEventListener("input",()=>{o=1,r(),m()}),t.addEventListener("change",()=>{o=1,r(),m()}),r(),m()}function M(){const n=document.getElementById("importFile"),t=document.getElementById("exportBtn"),s=document.getElementById("syncDown"),a=document.getElementById("fileListContainer"),o=document.getElementById("fileList");t&&t.addEventListener("click",()=>{const e={settings:h.settings,data:h.records.reduce((m,d)=>(m[d.id]=d,m),{})},i=JSON.stringify(e,null,2),r=new Blob([i],{type:"application/json"}),c=URL.createObjectURL(r),g=document.createElement("a");g.href=c,g.download=`javdb-extension-backup-${new Date().toISOString().split("T")[0]}.json`,g.click(),URL.revokeObjectURL(c),f("Data exported successfully.","success")}),n&&n.addEventListener("change",e=>{var c;const i=(c=e.target.files)==null?void 0:c[0];if(!i)return;const r=new FileReader;r.onload=async g=>{var d;const m=(d=g.target)==null?void 0:d.result;typeof m=="string"?await I(m):f("Failed to read file content.","error")},r.onerror=()=>{f(`Error reading file: ${r.error}`,"error")},r.readAsText(i)}),s&&s.addEventListener("click",()=>{s.textContent="正在获取列表...",s.disabled=!0,chrome.runtime.sendMessage({type:"webdav-list-files"},e=>{if(s.textContent="从云端恢复",s.disabled=!1,e!=null&&e.success)if(e.files&&e.files.length>0){o.innerHTML="",e.files.forEach(r=>{const c=document.createElement("li");c.textContent=`${r.name} (${r.lastModified})`,c.dataset.filename=r.name,c.dataset.filepath=r.path,c.classList.add("file-item"),c.addEventListener("click",()=>V(r)),o.appendChild(c)}),a.classList.remove("hidden"),f("获取文件列表成功，请点击文件进行恢复。");const i=document.querySelector('.tab-link[data-tab="tab-settings"]');i&&(i.click(),setTimeout(()=>{a.scrollIntoView({behavior:"smooth",block:"start"})},100))}else f("在云端未找到任何备份文件。","warn");else f(`获取文件列表失败: ${e.error}`,"error")})})}function S({title:n,message:t,onConfirm:s,onCancel:a,showRestoreOptions:o=!1,restoreOptions:e={settings:!0,records:!0}}){var u;const i=document.getElementById("confirmationModal"),r=document.getElementById("modalTitle"),c=document.getElementById("modalMessage"),g=document.getElementById("modalConfirmBtn"),m=document.getElementById("modalCancelBtn"),d=document.getElementById("modalRestoreOptions"),p=document.getElementById("modalRestoreSettings"),v=document.getElementById("modalRestoreRecords");r.textContent=n,c.textContent=t,o?(p.checked=e.settings,v.checked=e.records,d.classList.remove("hidden")):d.classList.add("hidden"),i.style.display="flex";const l=g.cloneNode(!0);(u=g.parentNode)==null||u.replaceChild(l,g),l.onclick=()=>{o?s({restoreSettings:p.checked,restoreRecords:v.checked}):s(),i.style.display="none"},m.onclick=()=>{a&&a(),i.style.display="none"}}function V(n){S({title:"确认恢复",message:`您确定要从文件 "${n.name}" 中恢复数据吗？此操作将覆盖本地数据。`,showRestoreOptions:!0,onConfirm:t=>{if(t){if(!t.restoreRecords&&!t.restoreSettings){f("您没有选择任何要恢复的内容。","warn");return}f("正在从云端恢复，请稍候...","info"),chrome.runtime.sendMessage({type:"webdav-restore",filename:n.path,options:t},s=>{s!=null&&s.success?(f("数据恢复成功！页面即将刷新以应用更改。","success"),setTimeout(()=>window.location.reload(),1500)):f(`恢复失败: ${s.error}`,"error")})}}})}async function I(n){try{const t=JSON.parse(n);let s=!1,a=!1;if(t.settings&&typeof t.settings=="object"&&(await w(t.settings),h.settings=await L(),s=!0),t.data&&typeof t.data=="object"&&t.data!==null){let o;Array.isArray(t.data)?(h.records=t.data,o=t.data.reduce((e,i)=>(i&&i.id&&(e[i.id]=i),e),{})):(o=t.data,h.records=Object.values(t.data)),await k(B.VIEWED_RECORDS,o),a=!0}s||a?(f("Data imported successfully. Page will reload to apply all changes."),setTimeout(()=>window.location.reload(),1500)):f('Imported file does not contain valid "settings" or "data" fields.',"warn")}catch(t){f(`Error applying imported data: ${t.message}`,"error"),console.error("Error applying imported data:",t)}}function N(){const n=document.getElementById("webdavEnabled"),t=document.getElementById("webdavUrl"),s=document.getElementById("webdavUser"),a=document.getElementById("webdavPass"),o=document.getElementById("webdavAutoSync"),e=document.getElementById("webdav-sync-interval"),i=document.getElementById("saveWebdavSettings"),r=document.getElementById("testWebdavConnection"),c=document.getElementById("last-sync-time"),g=document.getElementById("hideViewed"),m=document.getElementById("hideBrowsed"),d=document.getElementById("hideVR");function p(){const{webdav:u,display:E}=h.settings;n.checked=u.enabled,t.value=u.url,s.value=u.username,a.value=u.password,o.checked=u.autoSync,e.value=String(u.syncInterval),c.textContent=u.lastSync?new Date(u.lastSync).toLocaleString():"Never",document.getElementById("webdav-fields-container").style.display=u.enabled?"block":"none",g.checked=E.hideViewed,m.checked=E.hideBrowsed,d.checked=E.hideVR}async function v(){const u={...h.settings,webdav:{enabled:n.checked,url:t.value.trim(),username:s.value.trim(),password:a.value,autoSync:o.checked,syncInterval:parseInt(e.value,10),lastSync:h.settings.webdav.lastSync},display:{hideViewed:g.checked,hideBrowsed:m.checked,hideVR:d.checked}};await w(u),h.settings=u,chrome.runtime.sendMessage({type:"setup-alarms"}),f("Settings saved successfully!")}function l(){v().then(()=>{r.textContent="Testing...",r.disabled=!0,chrome.runtime.sendMessage({type:"webdav-test"},u=>{u.success?f("WebDAV connection successful!"):f(`WebDAV connection failed: ${u.error}`,"error"),r.textContent="Test Connection",r.disabled=!1})})}i.addEventListener("click",v),n.addEventListener("change",()=>{document.getElementById("webdav-fields-container").style.display=n.checked?"block":"none"}),r.addEventListener("click",l),g.addEventListener("change",v),m.addEventListener("change",v),d.addEventListener("change",v),p()}function J(){const n=document.getElementById("jsonConfig"),t=document.getElementById("editJsonBtn"),s=document.getElementById("saveJsonBtn"),a=document.getElementById("exportJsonBtn"),o=document.getElementById("importJsonBtn"),e=document.getElementById("importFileInput");if(!n||!t||!s||!a||!o||!e){console.error("One or more elements for Advanced Settings not found. Aborting init.");return}function i(){n.value=JSON.stringify({settings:h.settings,data:h.records},null,2)}function r(){n.readOnly=!1,n.focus(),t.classList.add("hidden"),s.classList.remove("hidden"),f("JSON editing enabled. Be careful!","warn")}async function c(){await I(n.value),n.readOnly=!0,s.classList.add("hidden"),t.classList.remove("hidden")}function g(){const d=n.value,p=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(p),l=document.createElement("a");l.href=v,l.download=`javdb-extension-backup-${new Date().toISOString().split("T")[0]}.json`,l.click(),URL.revokeObjectURL(v),f("Current JSON data exported successfully.")}function m(d){var l;const p=(l=d.target.files)==null?void 0:l[0];if(!p)return;const v=new FileReader;v.onload=u=>{var y;const E=(y=u.target)==null?void 0:y.result;typeof E=="string"&&(n.value=E,r(),f('File loaded into editor. Review and click "Save JSON" to apply.',"info"))},v.readAsText(p)}t.addEventListener("click",r),s.addEventListener("click",c),a.addEventListener("click",g),o.addEventListener("click",()=>e.click()),e.addEventListener("change",m),i()}function j(){const n=document.getElementById("log-level-filter"),t=document.getElementById("refresh-logs-button"),s=document.getElementById("clear-logs-button"),a=document.getElementById("log-body");if(!n||!a)return;let o=[];const e=()=>{const c=n.value;if(a.innerHTML="",o.length===0){a.innerHTML='<div class="no-logs-message">未找到日志。</div>';return}const g=o.filter(m=>c==="ALL"||m.level===c);if(g.length===0){a.innerHTML='<div class="no-logs-message">没有符合当前过滤条件的日志。</div>';return}for(const m of g.slice().reverse()){const d=document.createElement("div");d.className=`log-entry log-level-${m.level.toLowerCase()}`;const p=m.data?`
                <details class="log-data-details">
                    <summary>详细数据</summary>
                    <pre>${JSON.stringify(m.data,null,2)}</pre>
                </details>
            `:"";d.innerHTML=`
                <div class="log-header">
                    <span class="log-level-badge">${m.level}</span>
                    <span class="log-message">${m.message}</span>
                    <span class="log-timestamp">${new Date(m.timestamp).toLocaleString()}</span>
                </div>
                ${p}
            `,a.appendChild(d)}},i=(c=!1)=>{c&&f("正在刷新日志...","info"),chrome.runtime.sendMessage({type:"get-logs"},g=>{g!=null&&g.success?(o=g.logs||[],e(),c&&f("日志已成功刷新。","success")):f(c?"刷新日志失败，请稍后重试。":"获取日志记录失败。","error")})},r=()=>{S({title:"确认清空日志",message:"您确定要清空所有日志记录吗？此操作不可撤销。",onConfirm:()=>{chrome.runtime.sendMessage({type:"clear-logs"},c=>{c!=null&&c.success?(f("日志已成功清空。","success"),i()):f("清空日志失败，请稍后重试。","error")})}})};n.addEventListener("change",e),t.addEventListener("click",()=>i(!0)),s.addEventListener("click",r),i()}
