import"./modulepreload-polyfill-B5Qt9EMX.js";import{V as b,D as k,b as w,g as L,s as C,S as B,a as R}from"./storage-BUa3Gg3q.js";const y={settings:k,records:[],isInitialized:!1};async function x(){if(y.isInitialized)return;y.settings=await L();const n=await R(B.VIEWED_RECORDS,{});y.records=Object.values(n),y.isInitialized=!0,console.log("Global state initialized.",y)}function f(n,t="info"){const s=document.getElementById("messageContainer");if(!s){console.error("Message container not found!");return}const o=document.createElement("div"),i=t==="warn"?"info":t;o.className=`toast toast-${i}`,o.textContent=n;const e=document.createElement("i");t==="success"?e.className="fas fa-check-circle":t==="error"?e.className="fas fa-exclamation-circle":e.className="fas fa-info-circle",o.prepend(e),s.appendChild(o),setTimeout(()=>{o.classList.add("show")},10),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove())},5e3)}document.addEventListener("DOMContentLoaded",async()=>{await x(),$(),O(),V(),N(),J(),A(),D()});function $(){const n=document.querySelectorAll(".tab-link"),t=document.querySelectorAll(".tab-content"),s=e=>{var r;if(!e)return;const a=e.getAttribute("data-tab");a&&(n.forEach(c=>c.classList.remove("active")),t.forEach(c=>c.classList.remove("active")),e.classList.add("active"),(r=document.getElementById(a))==null||r.classList.add("active"),history.pushState?history.pushState(null,"",`#${a}`):location.hash=`#${a}`)};n.forEach(e=>{e.addEventListener("click",()=>{if(s(e),e.getAttribute("data-tab")==="tab-logs"){const a=document.getElementById("refresh-logs-button");a&&a.click()}})});const o=window.location.hash.substring(1)||"tab-records",i=document.querySelector(`.tab-link[data-tab="${o}"]`);s(i||n[0])}function D(){const n=document.getElementById("stats-overview");if(!n)return;const t=y.records.length,s=y.records.filter(e=>e.status===b.VIEWED).length,o=y.records.filter(e=>e.status===b.WANT).length,i=y.records.filter(e=>e.status===b.BROWSED).length;n.innerHTML=`
        <div>
            <span class="stat-value">${t}</span>
            <span class="stat-label">总记录</span>
        </div>
        <div>
            <span class="stat-value">${s}</span>
            <span class="stat-label">已观看</span>
        </div>
        <div>
            <span class="stat-value">${i}</span>
            <span class="stat-label">已浏览</span>
        </div>
        <div>
            <span class="stat-value">${o}</span>
            <span class="stat-label">想看</span>
        </div>
    `}function O(){const n=document.getElementById("searchInput"),t=document.getElementById("filterSelect"),s=document.getElementById("videoList"),o=document.querySelector(".pagination");if(!n||!s)return;let i=1;const e=20;let a=[];function r(){const d=n.value.toLowerCase(),p=t.value;a=y.records.filter(v=>{const l=!d||v.id.toLowerCase().includes(d)||v.title.toLowerCase().includes(d),u=p==="all"||v.status===p;return l&&u})}function c(){if(s.innerHTML="",a.length===0){s.innerHTML='<li class="empty-list">No records match your criteria.</li>';return}const d=(i-1)*e,p=a.slice(d,d+e),v=y.settings.searchEngines[0];p.forEach(l=>{const u=document.createElement("li");u.className="video-item";const E=v?v.urlTemplate.replace("{{ID}}",encodeURIComponent(l.id)):"#";u.innerHTML=`
                <span class="video-id"><a href="${E}" target="_blank">${l.id}</a></span>
                <span class="video-title">${l.title}</span>
                <span class="video-status status-${l.status}">${l.status}</span>
            `,s.appendChild(u)})}function g(){o.innerHTML="";const d=Math.ceil(a.length/e);if(d<=1)return;const p=(l,u=!1,E=!1)=>{const h=document.createElement("button");h.textContent=String(l),typeof l=="number"?(h.className=`page-button ${u?"active":""}`,h.addEventListener("click",()=>{i=l,m()})):(h.className="page-button ellipsis",E=!0),E&&(h.disabled=!0),o.appendChild(h)};if(d<=7)for(let l=1;l<=d;l++)p(l,l===i);else{let l=new Set;l.add(1),l.add(d),l.add(i);for(let h=-1;h<=1;h++)i+h>0&&i+h<=d&&l.add(i+h);let u=Array.from(l).sort((h,T)=>h-T),E=null;for(const h of u)E!==null&&h-E>1&&p("..."),p(h,h===i),E=h}}function m(){c(),g()}n.addEventListener("input",()=>{i=1,r(),m()}),t.addEventListener("change",()=>{i=1,r(),m()}),r(),m()}function A(){const n=document.getElementById("importFile"),t=document.getElementById("exportBtn"),s=document.getElementById("syncDown"),o=document.getElementById("fileListContainer"),i=document.getElementById("fileList");t&&t.addEventListener("click",()=>{const e={settings:y.settings,data:y.records.reduce((m,d)=>(m[d.id]=d,m),{})},a=JSON.stringify(e,null,2),r=new Blob([a],{type:"application/json"}),c=URL.createObjectURL(r),g=document.createElement("a");g.href=c,g.download=`javdb-extension-backup-${new Date().toISOString().split("T")[0]}.json`,g.click(),URL.revokeObjectURL(c),f("Data exported successfully.","success")}),n&&n.addEventListener("change",e=>{var c;const a=(c=e.target.files)==null?void 0:c[0];if(!a)return;const r=new FileReader;r.onload=async g=>{var d;const m=(d=g.target)==null?void 0:d.result;typeof m=="string"?await I(m):f("Failed to read file content.","error")},r.onerror=()=>{f(`Error reading file: ${r.error}`,"error")},r.readAsText(a)}),s&&s.addEventListener("click",()=>{s.textContent="正在获取列表...",s.disabled=!0,chrome.runtime.sendMessage({type:"webdav-list-files"},e=>{if(s.textContent="从云端恢复",s.disabled=!1,e!=null&&e.success)if(e.files&&e.files.length>0){i.innerHTML="",e.files.forEach(r=>{const c=document.createElement("li");c.textContent=`${r.name} (${r.lastModified})`,c.dataset.filename=r.name,c.dataset.filepath=r.path,c.classList.add("file-item"),c.addEventListener("click",()=>M(r)),i.appendChild(c)}),o.classList.remove("hidden"),f("获取文件列表成功，请点击文件进行恢复。");const a=document.querySelector('.tab-link[data-tab="tab-settings"]');a&&(a.click(),setTimeout(()=>{o.scrollIntoView({behavior:"smooth",block:"start"})},100))}else f("在云端未找到任何备份文件。","warn");else f(`获取文件列表失败: ${e.error}`,"error")})})}function S({title:n,message:t,onConfirm:s,onCancel:o,showRestoreOptions:i=!1,restoreOptions:e={settings:!0,records:!0}}){var u;const a=document.getElementById("confirmationModal"),r=document.getElementById("modalTitle"),c=document.getElementById("modalMessage"),g=document.getElementById("modalConfirmBtn"),m=document.getElementById("modalCancelBtn"),d=document.getElementById("modalRestoreOptions"),p=document.getElementById("modalRestoreSettings"),v=document.getElementById("modalRestoreRecords");r.textContent=n,c.textContent=t,i?(p.checked=e.settings,v.checked=e.records,d.classList.remove("hidden")):d.classList.add("hidden"),a.style.display="flex";const l=g.cloneNode(!0);(u=g.parentNode)==null||u.replaceChild(l,g),l.onclick=()=>{i?s({restoreSettings:p.checked,restoreRecords:v.checked}):s(),a.style.display="none"},m.onclick=()=>{o&&o(),a.style.display="none"}}function M(n){S({title:"确认恢复",message:`您确定要从文件 "${n.name}" 中恢复数据吗？此操作将覆盖本地数据。`,showRestoreOptions:!0,onConfirm:t=>{if(t){if(!t.restoreRecords&&!t.restoreSettings){f("您没有选择任何要恢复的内容。","warn");return}f("正在从云端恢复，请稍候...","info"),chrome.runtime.sendMessage({type:"webdav-restore",filename:n.path,options:t},s=>{s!=null&&s.success?(f("数据恢复成功！页面即将刷新以应用更改。","success"),setTimeout(()=>window.location.reload(),1500)):f(`恢复失败: ${s.error}`,"error")})}}})}async function I(n){try{const t=JSON.parse(n);let s=!1,o=!1;if(t.settings&&typeof t.settings=="object"&&(await w(t.settings),y.settings=await L(),s=!0),t.data&&typeof t.data=="object"&&t.data!==null){let i;Array.isArray(t.data)?(y.records=t.data,i=t.data.reduce((e,a)=>(a&&a.id&&(e[a.id]=a),e),{})):(i=t.data,y.records=Object.values(t.data)),await C(B.VIEWED_RECORDS,i),o=!0}s||o?(f("Data imported successfully. Page will reload to apply all changes."),setTimeout(()=>window.location.reload(),1500)):f('Imported file does not contain valid "settings" or "data" fields.',"warn")}catch(t){f(`Error applying imported data: ${t.message}`,"error"),console.error("Error applying imported data:",t)}}function V(){const n=document.getElementById("webdavEnabled"),t=document.getElementById("webdavUrl"),s=document.getElementById("webdavUser"),o=document.getElementById("webdavPass"),i=document.getElementById("webdavAutoSync"),e=document.getElementById("webdav-sync-interval"),a=document.getElementById("saveWebdavSettings"),r=document.getElementById("testWebdavConnection"),c=document.getElementById("last-sync-time"),g=document.getElementById("hideViewed"),m=document.getElementById("hideBrowsed"),d=document.getElementById("hideVR");function p(){const{webdav:u,display:E}=y.settings;n.checked=u.enabled,t.value=u.url,s.value=u.username,o.value=u.password,i.checked=u.autoSync,e.value=String(u.syncInterval),c.textContent=u.lastSync?new Date(u.lastSync).toLocaleString():"Never",document.getElementById("webdav-fields-container").style.display=u.enabled?"block":"none",g.checked=E.hideViewed,m.checked=E.hideBrowsed,d.checked=E.hideVR}async function v(){const u={...y.settings,webdav:{enabled:n.checked,url:t.value.trim(),username:s.value.trim(),password:o.value,autoSync:i.checked,syncInterval:parseInt(e.value,10),lastSync:y.settings.webdav.lastSync},display:{hideViewed:g.checked,hideBrowsed:m.checked,hideVR:d.checked}};await w(u),y.settings=u,chrome.runtime.sendMessage({type:"setup-alarms"}),f("Settings saved successfully!")}function l(){v().then(()=>{r.textContent="Testing...",r.disabled=!0,chrome.runtime.sendMessage({type:"webdav-test"},u=>{u.success?f("WebDAV connection successful!"):f(`WebDAV connection failed: ${u.error}`,"error"),r.textContent="Test Connection",r.disabled=!1})})}a.addEventListener("click",v),n.addEventListener("change",()=>{document.getElementById("webdav-fields-container").style.display=n.checked?"block":"none"}),r.addEventListener("click",l),g.addEventListener("change",v),m.addEventListener("change",v),d.addEventListener("change",v),p()}function N(){const n=document.getElementById("jsonConfig"),t=document.getElementById("editJsonBtn"),s=document.getElementById("saveJsonBtn"),o=document.getElementById("exportJsonBtn"),i=document.getElementById("importJsonBtn"),e=document.getElementById("importFileInput");if(!n||!t||!s||!o||!i||!e){console.error("One or more elements for Advanced Settings not found. Aborting init.");return}function a(){n.value=JSON.stringify({settings:y.settings,data:y.records},null,2)}function r(){n.readOnly=!1,n.focus(),t.classList.add("hidden"),s.classList.remove("hidden"),f("JSON editing enabled. Be careful!","warn")}async function c(){await I(n.value),n.readOnly=!0,s.classList.add("hidden"),t.classList.remove("hidden")}function g(){const d=n.value,p=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(p),l=document.createElement("a");l.href=v,l.download=`javdb-extension-backup-${new Date().toISOString().split("T")[0]}.json`,l.click(),URL.revokeObjectURL(v),f("Current JSON data exported successfully.")}function m(d){var l;const p=(l=d.target.files)==null?void 0:l[0];if(!p)return;const v=new FileReader;v.onload=u=>{var h;const E=(h=u.target)==null?void 0:h.result;typeof E=="string"&&(n.value=E,r(),f('File loaded into editor. Review and click "Save JSON" to apply.',"info"))},v.readAsText(p)}t.addEventListener("click",r),s.addEventListener("click",c),o.addEventListener("click",g),i.addEventListener("click",()=>e.click()),e.addEventListener("change",m),a()}function J(){const n=document.getElementById("log-level-filter"),t=document.getElementById("refresh-logs-button"),s=document.getElementById("clear-logs-button"),o=document.getElementById("log-body");if(!n||!o)return;let i=[];const e=()=>{const c=n.value;if(o.innerHTML="",i.length===0){o.innerHTML='<div class="no-logs-message">未找到日志。</div>';return}const g=i.filter(m=>c==="ALL"||m.level===c);if(g.length===0){o.innerHTML='<div class="no-logs-message">没有符合当前过滤条件的日志。</div>';return}for(const m of g.slice().reverse()){const d=document.createElement("div");d.className=`log-entry log-level-${m.level.toLowerCase()}`;const p=m.data?`
                <details class="log-data-details">
                    <summary>详细数据</summary>
                    <pre>${JSON.stringify(m.data,null,2)}</pre>
                </details>
            `:"";d.innerHTML=`
                <div class="log-header">
                    <span class="log-level-badge">${m.level}</span>
                    <span class="log-message">${m.message}</span>
                    <span class="log-timestamp">${new Date(m.timestamp).toLocaleString()}</span>
                </div>
                ${p}
            `,o.appendChild(d)}},a=(c=!1)=>{c&&f("正在刷新日志...","info"),chrome.runtime.sendMessage({type:"get-logs"},g=>{g!=null&&g.success?(i=g.logs||[],e(),c&&f("日志已成功刷新。","success")):f(c?"刷新日志失败，请稍后重试。":"获取日志记录失败。","error")})},r=()=>{S({title:"确认清空日志",message:"您确定要清空所有日志记录吗？此操作不可撤销。",onConfirm:()=>{chrome.runtime.sendMessage({type:"clear-logs"},c=>{c!=null&&c.success?(f("日志已成功清空。","success"),a()):f("清空日志失败，请稍后重试。","error")})}})};n.addEventListener("change",e),t.addEventListener("click",()=>a(!0)),s.addEventListener("click",r),a()}
