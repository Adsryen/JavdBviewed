import{g as y,a as v,V as f,s as T}from"./storage-Pif_YOsy.js";const i={settings:null,records:{},isSearchPage:!1,observer:null,debounceTimer:null,originalFaviconUrl:""},d={MOVIE_LIST_ITEM:".movie-list .item",VIDEO_TITLE:"div.video-title > strong",VIDEO_ID:".uid, .item-id > strong",TAGS_CONTAINER:".tags.has-addons",FAVICON:"link[rel~='icon']",VIDEO_DETAIL_ID:".panel-block.first-block",SEARCH_RESULT_PAGE:".container .column.is-9",EXPORT_TOOLBAR:".toolbar, .breadcrumb ul"},g=(...e)=>console.log("[JavDB Ext]",...e);async function O(){g("Extension initializing...");const[e,t]=await Promise.all([y(),v("viewed",{})]);i.settings=e,i.records=t,g(`Loaded ${Object.keys(i.records).length} records.`),i.isSearchPage=!!document.querySelector(d.SEARCH_RESULT_PAGE),i.isSearchPage&&g("Search page detected, hiding functions will be disabled.");const n=document.querySelector(d.FAVICON);n&&(i.originalFaviconUrl=n.href),I(),x(),window.location.pathname.startsWith("/v/")&&await _(),R()}function I(){document.querySelectorAll(d.MOVIE_LIST_ITEM).forEach(V)}function x(){const e=document.querySelector(".movie-list");e&&(i.observer=new MutationObserver(t=>{t.forEach(n=>{n.addedNodes.length>0&&(i.debounceTimer&&clearTimeout(i.debounceTimer),i.debounceTimer=window.setTimeout(I,300))})}),i.observer.observe(e,{childList:!0,subtree:!0}))}function C(e){if(i.isSearchPage||!i.settings)return!1;const{hideViewed:t,hideBrowsed:n}=i.settings.display,o=i.records[e];if(!o)return!1;const r=o.status===f.VIEWED,a=o.status===f.BROWSED;return!!(t&&r||n&&a)}function V(e){var c,m,u,p;const t=e.querySelector(d.VIDEO_ID);if(!t)return;const n=(c=t.textContent)==null?void 0:c.trim();if(!n)return;e.querySelectorAll(".custom-status-tag").forEach(S=>S.remove());const o=e.querySelector(d.TAGS_CONTAINER);if(!o)return;const r=i.records[n];if(r)switch(r.status){case f.VIEWED:E(o,"已观看","is-success");break;case f.WANT:E(o,"我想看","is-info");break;case f.BROWSED:E(o,"已浏览","is-warning");break}const a=((u=(m=e.querySelector(".tag.is-link"))==null?void 0:m.textContent)==null?void 0:u.trim())==="VR";if((p=i.settings)!=null&&p.display.hideVR&&a){e.style.display="none";return}C(n)&&(e.style.display="none")}function E(e,t,n){const o=document.createElement("span");o.className=`tag ${n} is-light custom-status-tag`,o.textContent=t,e.appendChild(o)}async function _(){var a;const e=document.querySelector(d.VIDEO_DETAIL_ID);if(!e)return;const t=e.querySelector('a[href*="/video_codes/"]');if(!t)return;const n=(a=e.textContent)==null?void 0:a.match(/-(\d+)/),o=t.textContent+(n?n[0]:"");if(!o)return;i.records[o]?b(chrome.runtime.getURL("icons/jav.png")):setTimeout(async()=>{const c=await v("viewed",{});c[o]||(c[o]={id:o,title:document.title,status:f.BROWSED,timestamp:Date.now()},await T("viewed",c),g(`${o} added to history as 'browsed'.`),b(chrome.runtime.getURL("icons/jav.png")))},L(3e3,5e3))}function b(e){let t=document.querySelector(d.FAVICON);t||(t=document.createElement("link"),t.rel="icon",document.head.appendChild(t)),e.endsWith(".png")&&(t.type="image/png"),t.href=e}function L(e,t){return Math.floor(Math.random()*(t-e+1)+e)}let h=!1,s,l;function R(){[/https:\/\/javdb\.com\/users\/want_watch_videos.*/,/https:\/\/javdb\.com\/users\/watched_videos.*/,/https:\/\/javdb\.com\/users\/list_detail.*/,/https:\/\/javdb\.com\/lists.*/].some(t=>t.test(window.location.href))&&D()}function D(){const e=document.createElement("input");e.type="number",e.id="maxPageInput",e.placeholder="页数(空则全部)",e.className="input is-small",e.style.width="120px",e.style.marginRight="8px",s=document.createElement("button"),s.textContent="导出页面数据",s.className="button is-small is-primary",s.addEventListener("click",A),l=document.createElement("button"),l.textContent="停止",l.className="button is-small is-danger",l.style.marginLeft="8px",l.disabled=!0,l.addEventListener("click",q);const t=document.createElement("div");t.className="level-item",t.appendChild(e),t.appendChild(s),t.appendChild(l);const n=document.querySelector(d.EXPORT_TOOLBAR);n&&n.appendChild(t)}async function A(){const e=document.getElementById("maxPageInput"),t=N(),n=Math.ceil(t/20),o=e!=null&&e.value?parseInt(e.value):n,r=new URLSearchParams(window.location.search).get("page")||"1";h=!0,s&&(s.disabled=!0),l&&(l.disabled=!1);let a=[];for(let c=0;c<o&&h;c++){const m=parseInt(r)+c;if(m>n)break;if(s&&(s.textContent=`导出中... ${m}/${n}`),c>0){const u=new URL(window.location.href);u.searchParams.set("page",String(m)),window.location.href=u.href,await new Promise(p=>window.addEventListener("load",p,{once:!0}))}a=a.concat(P()),await new Promise(u=>setTimeout(u,1e3))}a.length>0&&k(a),w()}function P(){return Array.from(document.querySelectorAll(d.MOVIE_LIST_ITEM)).map(e=>{var o,r;const t=e.querySelector(d.VIDEO_ID),n=e.querySelector(d.VIDEO_TITLE);return{id:((o=t==null?void 0:t.textContent)==null?void 0:o.trim())||"",title:((r=n==null?void 0:n.textContent)==null?void 0:r.trim())||""}})}function k(e){const t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),o=URL.createObjectURL(n),r=document.createElement("a");r.download=`javdb-export-${new Date().toISOString().slice(0,10)}.json`,r.href=o,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}function N(){var t;const e=document.querySelector("a.is-active");if(e){const n=(t=e.textContent)==null?void 0:t.match(/\((\d+)\)/);return n?parseInt(n[1],10):0}return 0}function q(){h=!1,w()}function w(){h=!1,s&&(s.disabled=!1,s.textContent="导出页面数据"),l&&(l.disabled=!0)}O().catch(e=>console.error("[JavDB Ext] Initialization failed:",e));
