import"./modulepreload-polyfill-B5Qt9EMX.js";import{V as b,D as k,b as L,g as S,s as I,S as w,a as C}from"./storage-BUa3Gg3q.js";const u={settings:k,records:[],isInitialized:!1};async function R(){if(u.isInitialized)return;u.settings=await S();const s=await C(w.VIEWED_RECORDS,{});u.records=Object.values(s),u.isInitialized=!0,console.log("Global state initialized.",u)}function y(s,t="info"){const i=document.getElementById("messageContainer");if(!i){console.error("Message container not found!");return}const a=document.createElement("div"),n=t==="warn"?"info":t;a.className=`toast toast-${n}`,a.textContent=s;const e=document.createElement("i");t==="success"?e.className="fas fa-check-circle":t==="error"?e.className="fas fa-exclamation-circle":e.className="fas fa-info-circle",a.prepend(e),i.appendChild(a),setTimeout(()=>{a.classList.add("show")},10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},5e3)}document.addEventListener("DOMContentLoaded",async()=>{await R(),O(),$(),D(),V(),N(),A(),x()});function O(){const s=document.querySelectorAll(".tab-link"),t=document.querySelectorAll(".tab-content"),i=e=>{var g;if(!e)return;const l=e.getAttribute("data-tab");l&&(s.forEach(m=>m.classList.remove("active")),t.forEach(m=>m.classList.remove("active")),e.classList.add("active"),(g=document.getElementById(l))==null||g.classList.add("active"),history.pushState?history.pushState(null,"",`#${l}`):location.hash=`#${l}`)};s.forEach(e=>{e.addEventListener("click",()=>i(e))});const a=window.location.hash.substring(1)||"tab-records",n=document.querySelector(`.tab-link[data-tab="${a}"]`);i(n||s[0])}function x(){const s=document.getElementById("stats-overview");if(!s)return;const t=u.records.length,i=u.records.filter(e=>e.status===b.VIEWED).length,a=u.records.filter(e=>e.status===b.WANT).length,n=u.records.filter(e=>e.status===b.BROWSED).length;s.innerHTML=`
        <div>
            <span class="stat-value">${t}</span>
            <span class="stat-label">总记录</span>
        </div>
        <div>
            <span class="stat-value">${i}</span>
            <span class="stat-label">已观看</span>
        </div>
        <div>
            <span class="stat-value">${n}</span>
            <span class="stat-label">已浏览</span>
        </div>
        <div>
            <span class="stat-value">${a}</span>
            <span class="stat-label">想看</span>
        </div>
    `}function $(){const s=document.getElementById("searchInput"),t=document.getElementById("filterSelect"),i=document.getElementById("videoList"),a=document.querySelector(".pagination");if(!s||!i)return;let n=1;const e=20;let l=[];function g(){const d=s.value.toLowerCase(),p=t.value;l=u.records.filter(v=>{const o=!d||v.id.toLowerCase().includes(d)||v.title.toLowerCase().includes(d),c=p==="all"||v.status===p;return o&&c})}function m(){if(i.innerHTML="",l.length===0){i.innerHTML='<li class="empty-list">No records match your criteria.</li>';return}const d=(n-1)*e,p=l.slice(d,d+e),v=u.settings.searchEngines[0];p.forEach(o=>{const c=document.createElement("li");c.className="video-item";const h=v?v.urlTemplate.replace("{{ID}}",encodeURIComponent(o.id)):"#";c.innerHTML=`
                <span class="video-id"><a href="${h}" target="_blank">${o.id}</a></span>
                <span class="video-title">${o.title}</span>
                <span class="video-status status-${o.status}">${o.status}</span>
            `,i.appendChild(c)})}function E(){a.innerHTML="";const d=Math.ceil(l.length/e);if(d<=1)return;const p=(o,c=!1,h=!1)=>{const r=document.createElement("button");r.textContent=String(o),typeof o=="number"?(r.className=`page-button ${c?"active":""}`,r.addEventListener("click",()=>{n=o,f()})):(r.className="page-button ellipsis",h=!0),h&&(r.disabled=!0),a.appendChild(r)};if(d<=7)for(let o=1;o<=d;o++)p(o,o===n);else{let o=new Set;o.add(1),o.add(d),o.add(n);for(let r=-1;r<=1;r++)n+r>0&&n+r<=d&&o.add(n+r);let c=Array.from(o).sort((r,T)=>r-T),h=null;for(const r of c)h!==null&&r-h>1&&p("..."),p(r,r===n),h=r}}function f(){m(),E()}s.addEventListener("input",()=>{n=1,g(),f()}),t.addEventListener("change",()=>{n=1,g(),f()}),g(),f()}function A(){const s=document.getElementById("importFile"),t=document.getElementById("exportBtn");t&&t.addEventListener("click",()=>{const i=JSON.stringify({settings:u.settings,data:u.records},null,2),a=new Blob([i],{type:"application/json"}),n=URL.createObjectURL(a),e=document.createElement("a");e.href=n,e.download=`javdb-extension-backup-${new Date().toISOString().split("T")[0]}.json`,e.click(),URL.revokeObjectURL(n),y("Data exported successfully.")}),s&&s.addEventListener("change",i=>{var e;const a=(e=i.target.files)==null?void 0:e[0];if(!a)return;const n=new FileReader;n.onload=async l=>{var m;const g=(m=l.target)==null?void 0:m.result;typeof g=="string"?await B(g):y("Failed to read file content.","error")},n.onerror=()=>{y(`Error reading file: ${n.error}`,"error")},n.readAsText(a)})}async function B(s){try{const t=JSON.parse(s);let i=!1,a=!1;if(t.settings&&typeof t.settings=="object"&&(await L(t.settings),u.settings=await S(),i=!0),t.data&&typeof t.data=="object"&&t.data!==null){let n;Array.isArray(t.data)?(u.records=t.data,n=t.data.reduce((e,l)=>(l&&l.id&&(e[l.id]=l),e),{})):(n=t.data,u.records=Object.values(t.data)),await I(w.VIEWED_RECORDS,n),a=!0}i||a?(y("Data imported successfully. Page will reload to apply all changes."),setTimeout(()=>window.location.reload(),1500)):y('Imported file does not contain valid "settings" or "data" fields.',"warn")}catch(t){y(`Error applying imported data: ${t.message}`,"error"),console.error("Error applying imported data:",t)}}function D(){const s=document.getElementById("webdavEnabled"),t=document.getElementById("webdavUrl"),i=document.getElementById("webdavUser"),a=document.getElementById("webdavPass"),n=document.getElementById("webdavAutoSync"),e=document.getElementById("webdav-sync-interval"),l=document.getElementById("saveWebdavSettings"),g=document.getElementById("testWebdavConnection"),m=document.getElementById("last-sync-time"),E=document.getElementById("hideViewed"),f=document.getElementById("hideBrowsed"),d=document.getElementById("hideVR");function p(){const{webdav:c,display:h}=u.settings;s.checked=c.enabled,t.value=c.url,i.value=c.username,a.value=c.password,n.checked=c.autoSync,e.value=String(c.syncInterval),m.textContent=c.lastSync?new Date(c.lastSync).toLocaleString():"Never",document.getElementById("webdav-fields-container").style.display=c.enabled?"block":"none",E.checked=h.hideViewed,f.checked=h.hideBrowsed,d.checked=h.hideVR}async function v(){const c={...u.settings,webdav:{enabled:s.checked,url:t.value.trim(),username:i.value.trim(),password:a.value,autoSync:n.checked,syncInterval:parseInt(e.value,10),lastSync:u.settings.webdav.lastSync},display:{hideViewed:E.checked,hideBrowsed:f.checked,hideVR:d.checked}};await L(c),u.settings=c,chrome.runtime.sendMessage({type:"setup-alarms"}),y("Settings saved successfully!")}function o(){v().then(()=>{g.textContent="Testing...",g.disabled=!0,chrome.runtime.sendMessage({type:"webdav-test"},c=>{c.success?y("WebDAV connection successful!"):y(`WebDAV connection failed: ${c.error}`,"error"),g.textContent="Test Connection",g.disabled=!1})})}l.addEventListener("click",v),s.addEventListener("change",()=>{document.getElementById("webdav-fields-container").style.display=s.checked?"block":"none"}),g.addEventListener("click",o),E.addEventListener("change",v),f.addEventListener("change",v),d.addEventListener("change",v),p()}function V(){const s=document.getElementById("jsonConfig"),t=document.getElementById("editJsonBtn"),i=document.getElementById("saveJsonBtn"),a=document.getElementById("exportJsonBtn"),n=document.getElementById("importJsonBtn"),e=document.getElementById("importFileInput");if(!s||!t||!i||!a||!n||!e){console.error("One or more elements for Advanced Settings not found. Aborting init.");return}function l(){s.value=JSON.stringify({settings:u.settings,data:u.records},null,2)}function g(){s.readOnly=!1,s.focus(),t.classList.add("hidden"),i.classList.remove("hidden"),y("JSON editing enabled. Be careful!","warn")}async function m(){await B(s.value),s.readOnly=!0,i.classList.add("hidden"),t.classList.remove("hidden")}function E(){const d=s.value,p=new Blob([d],{type:"application/json"}),v=URL.createObjectURL(p),o=document.createElement("a");o.href=v,o.download=`javdb-extension-backup-${new Date().toISOString().split("T")[0]}.json`,o.click(),URL.revokeObjectURL(v),y("Current JSON data exported successfully.")}function f(d){var o;const p=(o=d.target.files)==null?void 0:o[0];if(!p)return;const v=new FileReader;v.onload=c=>{var r;const h=(r=c.target)==null?void 0:r.result;typeof h=="string"&&(s.value=h,g(),y('File loaded into editor. Review and click "Save JSON" to apply.',"info"))},v.readAsText(p)}t.addEventListener("click",g),i.addEventListener("click",m),a.addEventListener("click",E),n.addEventListener("click",()=>e.click()),e.addEventListener("change",f),l()}function N(){const s=document.getElementById("log-level-filter"),t=document.getElementById("refresh-logs-button"),i=document.getElementById("clear-logs-button"),a=document.getElementById("log-body");if(!s||!a)return;let n=[];const e=()=>{const m=s.value;if(a.innerHTML="",n.length===0){a.innerHTML='<tr><td colspan="4" style="text-align: center;">No logs found.</td></tr>';return}const E=n.filter(f=>m==="ALL"||f.level===m);for(const f of E.slice().reverse()){const d=a.insertRow();d.innerHTML=`
                <td class="timestamp">${new Date(f.timestamp).toLocaleString()}</td>
                <td class="level level-${f.level}">${f.level}</td>
                <td class="message">${f.message}</td>
                <td class="data">${f.data?`<pre>${JSON.stringify(f.data,null,2)}</pre>`:""}</td>
            `}},l=()=>{chrome.runtime.sendMessage({type:"get-logs"},m=>{m!=null&&m.success?(n=m.logs||[],e()):y("Failed to fetch logs.","error")})},g=()=>{confirm("Are you sure you want to clear all logs? This cannot be undone.")&&I(w.LOGS,[]).then(()=>{y("Logs cleared successfully."),l()})};s.addEventListener("change",e),t.addEventListener("click",l),i.addEventListener("click",g),l()}
