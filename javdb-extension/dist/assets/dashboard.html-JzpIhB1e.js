import"./modulepreload-polyfill-B5Qt9EMX.js";import{V as b,D as T,b as w,g as L,s as C,S as B,a as R}from"./storage-BUa3Gg3q.js";const h={settings:T,records:[],isInitialized:!1};async function x(){if(h.isInitialized)return;h.settings=await L();const n=await R(B.VIEWED_RECORDS,{});h.records=Object.values(n),h.isInitialized=!0,console.log("Global state initialized.",h)}function v(n,t="info"){const s=document.getElementById("messageContainer");if(!s){console.error("Message container not found!");return}const c=document.createElement("div"),o=t==="warn"?"info":t;c.className=`toast toast-${o}`,c.textContent=n;const e=document.createElement("i");t==="success"?e.className="fas fa-check-circle":t==="error"?e.className="fas fa-exclamation-circle":e.className="fas fa-info-circle",c.prepend(e),s.appendChild(c),setTimeout(()=>{c.classList.add("show")},10),setTimeout(()=>{c.classList.remove("show"),c.addEventListener("transitionend",()=>c.remove())},5e3)}document.addEventListener("DOMContentLoaded",async()=>{await x(),$(),O(),N(),V(),J(),M(),D()});function $(){const n=document.querySelectorAll(".tab-link"),t=document.querySelectorAll(".tab-content"),s=e=>{var l;if(!e)return;const a=e.getAttribute("data-tab");a&&(n.forEach(i=>i.classList.remove("active")),t.forEach(i=>i.classList.remove("active")),e.classList.add("active"),(l=document.getElementById(a))==null||l.classList.add("active"),history.pushState?history.pushState(null,"",`#${a}`):location.hash=`#${a}`)};n.forEach(e=>{e.addEventListener("click",()=>{if(s(e),e.getAttribute("data-tab")==="tab-logs"){const a=document.getElementById("refresh-logs-button");a&&a.click()}})});const c=window.location.hash.substring(1)||"tab-records",o=document.querySelector(`.tab-link[data-tab="${c}"]`);s(o||n[0])}function D(){const n=document.getElementById("stats-overview");if(!n)return;const t=h.records.length,s=h.records.filter(e=>e.status===b.VIEWED).length,c=h.records.filter(e=>e.status===b.WANT).length,o=h.records.filter(e=>e.status===b.BROWSED).length;n.innerHTML=`
        <div>
            <span class="stat-value">${t}</span>
            <span class="stat-label">总记录</span>
        </div>
        <div>
            <span class="stat-value">${s}</span>
            <span class="stat-label">已观看</span>
        </div>
        <div>
            <span class="stat-value">${o}</span>
            <span class="stat-label">已浏览</span>
        </div>
        <div>
            <span class="stat-value">${c}</span>
            <span class="stat-label">想看</span>
        </div>
    `}function O(){const n=document.getElementById("searchInput"),t=document.getElementById("filterSelect"),s=document.getElementById("videoList"),c=document.querySelector(".pagination");if(!n||!s)return;let o=1;const e=20;let a=[];function l(){const r=n.value.toLowerCase(),E=t.value;a=h.records.filter(g=>{const d=!r||g.id.toLowerCase().includes(r)||g.title.toLowerCase().includes(r),u=E==="all"||g.status===E;return d&&u})}function i(){if(s.innerHTML="",a.length===0){s.innerHTML='<li class="empty-list">No records match your criteria.</li>';return}const r=(o-1)*e,E=a.slice(r,r+e),g=h.settings.searchEngines[0];E.forEach(d=>{const u=document.createElement("li");u.className="video-item";const p=g?g.urlTemplate.replace("{{ID}}",encodeURIComponent(d.id)):"#";u.innerHTML=`
                <span class="video-id"><a href="${p}" target="_blank">${d.id}</a></span>
                <span class="video-title">${d.title}</span>
                <span class="video-status status-${d.status}">${d.status}</span>
            `,s.appendChild(u)})}function y(){c.innerHTML="";const r=Math.ceil(a.length/e);if(r<=1)return;const E=(d,u=!1,p=!1)=>{const f=document.createElement("button");f.textContent=String(d),typeof d=="number"?(f.className=`page-button ${u?"active":""}`,f.addEventListener("click",()=>{o=d,m()})):(f.className="page-button ellipsis",p=!0),p&&(f.disabled=!0),c.appendChild(f)};if(r<=7)for(let d=1;d<=r;d++)E(d,d===o);else{let d=new Set;d.add(1),d.add(r),d.add(o);for(let f=-1;f<=1;f++)o+f>0&&o+f<=r&&d.add(o+f);let u=Array.from(d).sort((f,k)=>f-k),p=null;for(const f of u)p!==null&&f-p>1&&E("..."),E(f,f===o),p=f}}function m(){i(),y()}n.addEventListener("input",()=>{o=1,l(),m()}),t.addEventListener("change",()=>{o=1,l(),m()}),l(),m()}function M(){const n=document.getElementById("importFile"),t=document.getElementById("exportBtn"),s=document.getElementById("syncDown"),c=document.getElementById("fileListContainer"),o=document.getElementById("fileList");t&&t.addEventListener("click",()=>{const e={settings:h.settings,data:h.records.reduce((m,r)=>(m[r.id]=r,m),{})},a=JSON.stringify(e,null,2),l=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(l),y=document.createElement("a");y.href=i,y.download=`javdb-extension-backup-${new Date().toISOString().split("T")[0]}.json`,y.click(),URL.revokeObjectURL(i),v("Data exported successfully.","success")}),n&&n.addEventListener("change",e=>{var i;const a=(i=e.target.files)==null?void 0:i[0];if(!a)return;const l=new FileReader;l.onload=async y=>{var r;const m=(r=y.target)==null?void 0:r.result;typeof m=="string"?await I(m):v("Failed to read file content.","error")},l.onerror=()=>{v(`Error reading file: ${l.error}`,"error")},l.readAsText(a)}),s&&s.addEventListener("click",()=>{s.textContent="正在获取列表...",s.disabled=!0,chrome.runtime.sendMessage({type:"webdav-list-files"},e=>{var a;s.textContent="从云端恢复...",s.disabled=!1,e!=null&&e.success?e.files&&e.files.length>0?(o.innerHTML="",e.files.forEach(l=>{const i=document.createElement("li");i.textContent=`${l.name} (${l.lastModified})`,i.dataset.filename=l.name,i.dataset.filepath=l.path,i.classList.add("file-item"),i.addEventListener("click",()=>A(l)),o.appendChild(i)}),c.classList.remove("hidden"),v("获取文件列表成功，请点击文件进行恢复。"),(a=document.querySelector('.tab-link[data-tab="tab-settings"]'))==null||a.dispatchEvent(new MouseEvent("click"))):v("在云端未找到任何备份文件。","warn"):v(`获取文件列表失败: ${e.error}`,"error")})})}function S({title:n,message:t,onConfirm:s,onCancel:c,showRestoreOptions:o=!1,restoreOptions:e={settings:!0,records:!0}}){var u;const a=document.getElementById("confirmationModal"),l=document.getElementById("modalTitle"),i=document.getElementById("modalMessage"),y=document.getElementById("modalConfirmBtn"),m=document.getElementById("modalCancelBtn"),r=document.getElementById("modalRestoreOptions"),E=document.getElementById("modalRestoreSettings"),g=document.getElementById("modalRestoreRecords");l.textContent=n,i.textContent=t,o?(E.checked=e.settings,g.checked=e.records,r.classList.remove("hidden")):r.classList.add("hidden"),a.style.display="flex";const d=y.cloneNode(!0);(u=y.parentNode)==null||u.replaceChild(d,y),d.onclick=()=>{o?s({restoreSettings:E.checked,restoreRecords:g.checked}):s(),a.style.display="none"},m.onclick=()=>{c&&c(),a.style.display="none"}}function A(n){S({title:"确认恢复",message:`您确定要从文件 "${n.name}" 中恢复数据吗？此操作将覆盖本地数据。`,showRestoreOptions:!0,onConfirm:t=>{if(t){if(!t.restoreRecords&&!t.restoreSettings){v("您没有选择任何要恢复的内容。","warn");return}v("正在从云端恢复，请稍候...","info"),chrome.runtime.sendMessage({type:"webdav-restore",filename:n.path,options:t},s=>{s!=null&&s.success?(v("数据恢复成功！页面即将刷新以应用更改。","success"),setTimeout(()=>window.location.reload(),1500)):v(`恢复失败: ${s.error}`,"error")})}}})}async function I(n){try{const t=JSON.parse(n);let s=!1,c=!1;if(t.settings&&typeof t.settings=="object"&&(await w(t.settings),h.settings=await L(),s=!0),t.data&&typeof t.data=="object"&&t.data!==null){let o;Array.isArray(t.data)?(h.records=t.data,o=t.data.reduce((e,a)=>(a&&a.id&&(e[a.id]=a),e),{})):(o=t.data,h.records=Object.values(t.data)),await C(B.VIEWED_RECORDS,o),c=!0}s||c?(v("Data imported successfully. Page will reload to apply all changes."),setTimeout(()=>window.location.reload(),1500)):v('Imported file does not contain valid "settings" or "data" fields.',"warn")}catch(t){v(`Error applying imported data: ${t.message}`,"error"),console.error("Error applying imported data:",t)}}function N(){const n=document.getElementById("webdavEnabled"),t=document.getElementById("webdavUrl"),s=document.getElementById("webdavUser"),c=document.getElementById("webdavPass"),o=document.getElementById("webdavAutoSync"),e=document.getElementById("webdav-sync-interval"),a=document.getElementById("saveWebdavSettings"),l=document.getElementById("testWebdavConnection"),i=document.getElementById("last-sync-time"),y=document.getElementById("hideViewed"),m=document.getElementById("hideBrowsed"),r=document.getElementById("hideVR");function E(){const{webdav:u,display:p}=h.settings;n.checked=u.enabled,t.value=u.url,s.value=u.username,c.value=u.password,o.checked=u.autoSync,e.value=String(u.syncInterval),i.textContent=u.lastSync?new Date(u.lastSync).toLocaleString():"Never",document.getElementById("webdav-fields-container").style.display=u.enabled?"block":"none",y.checked=p.hideViewed,m.checked=p.hideBrowsed,r.checked=p.hideVR}async function g(){const u={...h.settings,webdav:{enabled:n.checked,url:t.value.trim(),username:s.value.trim(),password:c.value,autoSync:o.checked,syncInterval:parseInt(e.value,10),lastSync:h.settings.webdav.lastSync},display:{hideViewed:y.checked,hideBrowsed:m.checked,hideVR:r.checked}};await w(u),h.settings=u,chrome.runtime.sendMessage({type:"setup-alarms"}),v("Settings saved successfully!")}function d(){g().then(()=>{l.textContent="Testing...",l.disabled=!0,chrome.runtime.sendMessage({type:"webdav-test"},u=>{u.success?v("WebDAV connection successful!"):v(`WebDAV connection failed: ${u.error}`,"error"),l.textContent="Test Connection",l.disabled=!1})})}a.addEventListener("click",g),n.addEventListener("change",()=>{document.getElementById("webdav-fields-container").style.display=n.checked?"block":"none"}),l.addEventListener("click",d),y.addEventListener("change",g),m.addEventListener("change",g),r.addEventListener("change",g),E()}function V(){const n=document.getElementById("jsonConfig"),t=document.getElementById("editJsonBtn"),s=document.getElementById("saveJsonBtn"),c=document.getElementById("exportJsonBtn"),o=document.getElementById("importJsonBtn"),e=document.getElementById("importFileInput");if(!n||!t||!s||!c||!o||!e){console.error("One or more elements for Advanced Settings not found. Aborting init.");return}function a(){n.value=JSON.stringify({settings:h.settings,data:h.records},null,2)}function l(){n.readOnly=!1,n.focus(),t.classList.add("hidden"),s.classList.remove("hidden"),v("JSON editing enabled. Be careful!","warn")}async function i(){await I(n.value),n.readOnly=!0,s.classList.add("hidden"),t.classList.remove("hidden")}function y(){const r=n.value,E=new Blob([r],{type:"application/json"}),g=URL.createObjectURL(E),d=document.createElement("a");d.href=g,d.download=`javdb-extension-backup-${new Date().toISOString().split("T")[0]}.json`,d.click(),URL.revokeObjectURL(g),v("Current JSON data exported successfully.")}function m(r){var d;const E=(d=r.target.files)==null?void 0:d[0];if(!E)return;const g=new FileReader;g.onload=u=>{var f;const p=(f=u.target)==null?void 0:f.result;typeof p=="string"&&(n.value=p,l(),v('File loaded into editor. Review and click "Save JSON" to apply.',"info"))},g.readAsText(E)}t.addEventListener("click",l),s.addEventListener("click",i),c.addEventListener("click",y),o.addEventListener("click",()=>e.click()),e.addEventListener("change",m),a()}function J(){const n=document.getElementById("log-level-filter"),t=document.getElementById("refresh-logs-button"),s=document.getElementById("clear-logs-button"),c=document.getElementById("log-body");if(!n||!c)return;let o=[];const e=()=>{const i=n.value;if(c.innerHTML="",o.length===0){c.innerHTML='<tr><td colspan="4" style="text-align: center;">No logs found.</td></tr>';return}const y=o.filter(m=>i==="ALL"||m.level===i);for(const m of y.slice().reverse()){const r=c.insertRow();r.innerHTML=`
                <td class="timestamp">${new Date(m.timestamp).toLocaleString()}</td>
                <td class="level level-${m.level}">${m.level}</td>
                <td class="message">${m.message}</td>
                <td class="data">${m.data?`<pre>${JSON.stringify(m.data,null,2)}</pre>`:""}</td>
            `}},a=()=>{chrome.runtime.sendMessage({type:"get-logs"},i=>{i!=null&&i.success?(o=i.logs||[],e()):v("Failed to fetch logs.","error")})},l=()=>{S({title:"确认清空日志",message:"您确定要清空所有日志记录吗？此操作不可撤销。",onConfirm:()=>{chrome.runtime.sendMessage({type:"clear-logs"},i=>{i!=null&&i.success?(v("日志已成功清空。","success"),a()):v("清空日志失败，请稍后重试。","error")})}})};n.addEventListener("change",e),t.addEventListener("click",a),s.addEventListener("click",l),a()}
